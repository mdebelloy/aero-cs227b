<html>

<!--=======================================================================-->

<head>
  <title>Aero</title>
  <script type='text/javascript' src='http://epilog.stanford.edu/javascript/epilog.js'></script>
  <script type='text/javascript' src='http://gamemaster.stanford.edu/javascript/localstorage.js'></script>
  <script type='text/javascript' src='http://gamemaster.stanford.edu/interpreter/general.js'></script>
  <script type='text/javascript'>
//==============================================================================


var manager = 'manager';
var player = 'aero';

var role = 'robot';
var rules = [];
var startclock = 10;
var playclock = 10;

var library = [];
var roles = [];
var state = [];

//==============================================================================
/*
Writeup:

/* PESSIMISTIC EVAL
function pessimistic_eval (role, state) {
    var state_value = 0;
    if (findterminalp(state, library)) {
        state_value = goal(role, state);
    }
    value(state)=state_value;
}
*/

/* MOBILITY FUNCTION
function mobility (role, state) {
  var actions = findlegals(role,state,library);
  var feasibles = findactions(role,library);

  var active = findcontrol(state,library); 
  var score = 0;

  if (active === role) {
    score = (actions.length/feasibles.length) * 100;
  } else {
    score = (100 - actions.length/feasibles.length) * 100;
  }
  return score;
}
}
*/

/* INTERMEDIATE REWARD
function intermediate_reward (role, state) {
    return findreward(role, state, library);
}
*/


/*  BOUNDED DEPTH MINIMAX
function playminimaxdepth (role)
  {var actions = shuffle(findlegals(state,library));
  if (actions.length===0) {return false};
  if (actions.length===1) {return actions[0]};
  var action = actions[0];
  var score = 0;
  var depth = 3;
  nodes = 0
  for (var i=0; i<actions.length; i++)
      {//console.log(grind(actions[i]));
        var newstate = simulate(actions[i],state,library);
        var newscore = minimaxdepth(role,newstate,depth);
        //console.log(newscore);
        if (newscore===100) {return actions[i]};
        if (newscore>score) {action = actions[i]; score = newscore}};
  return action}
*/

//==============================================================================

var nodes = 0;
var terminals = 0;
var elapsed = 0;
var mobilityCoef = 0.5;
var maxNodes = 0;
var visitedStates = {};


function intermediate_reward (role, state) {
    return findreward(role, state, library) * 1;
}

function mobility (r, state, library) {
  var actions = findlegals(state,library);
  var feasibles = findactions(library);

  if (r === role) {
    return (actions.length/feasibles.length) * 100
  } else {
    return 100 - (actions.length/feasibles.length) * 100
  }
}




function playIterativeDeepening(role) {
  var actions = shuffle(findlegals(state, library));
  if (actions.length === 0) { return false; }
  if (actions.length === 1) { return actions[0]; }
  var deadline = Date.now() + (playclock - 1) * 1000;
  var bestAction = actions[0];
  var bestScore = -Infinity;
  for (var depth = 1; depth <= 10; depth++) {
    console.log("Starting depth ", depth)
    nodes = 0;
    terminals = 0;
    var timeOut = false;
    for (var i = 0; i < actions.length; i++) {
      var newstate = simulate(actions[i], state, library);
      var score = minimaxdepth(role, newstate, depth, deadline);
      if (score === false) {
        timeOut = true;
        break;
      }
      /* can we assume min-max scores are 0-100??
      if (score === 100) {
        return actions[i];
      }
      */

      if (score > bestScore) {
        var newStateSignature = JSON.stringify(actions[i]);
        if (newStateSignature in visitedStates && visitedStates[newStateSignature] == role) {
          score *= 0.8; 
        }
        if(score > bestScore){
          bestAction = actions[i];
          bestScore = score;
        }
      }
    }
    if (timeOut || (maxNodes === nodes)) {
      break
    }
    maxNodes = nodes;
    console.log("Finished depth: ", depth, ", Found: ", nodes, " nodes, Best score: ", bestScore);
  }
  return bestAction;
}


function minimaxdepth(role, state, depth, deadline) {
  if (Date.now() > deadline) {
    return false;
  }
  nodes++;
  if (findterminalp(state, library)) {
    terminals++;
    return findreward(role, state, library) * 1;
  }
  if (depth <= 0) {
    terminals++;
    return mobilityCoef * mobility(role, state, library) + (1-mobilityCoef) * intermediate_reward(role, state);
  }
  var active = findcontrol(state, library);
  if (active === role) {
    return maximizedepth(active, role, state, depth, deadline);
  }
  return minimizedepth(active, role, state, depth, deadline);
}


function maximizedepth(active, role, state, depth, deadline) {
  var actions = findlegals(state, library);
  if (actions.length === 0) {
    return 0;
  }
  var score = -Infinity;
  for (var i = 0; i < actions.length; i++) {
    if (Date.now() > deadline) {
      return false;
    }
    var newstate = simulate(actions[i], state, library);
    var newscore = minimaxdepth(role, newstate, depth - 1, deadline);
    if (newscore === false) {
      return false;
    }
    /* can we assume min-max scores are 0-100??
    if (newscore === 100) {
      return 100;
    }
    */
    if (newscore > score) {
      score = newscore;
    }
  }
  return score;
}


function minimizedepth(active, role, state, depth, deadline) {
  var actions = findlegals(state, library);
  if (actions.length === 0) {
    return 0;
  }
  var score = Infinity;
  for (var i = 0; i < actions.length; i++) {
    if (Date.now() > deadline) {
      return false;
    }
    var newstate = simulate(actions[i], state, library);
    var newscore = minimaxdepth(role, newstate, depth - 1, deadline);
    if (newscore === false) {
      return false;
    }
    /* can we assume min-max scores are 0-100??
    if (newscore === 0) {
      return 0;
    }
    */
    if (newscore < score) {
      score = newscore;
    }
  }
  return score;
}



function betterp (x,y)
  {if (x[0]>y[0]) {return true};
  if (x[0]===y[0]) {return (x[1]>y[1])};
  return false}

function worsep (x,y)
  {if (x[0]<y[0]) {return true};
  if (x[0]===y[0]) {return (x[1]<y[1])};
  return false}

function shuffle (array)
  {for (var i = array.length-1; i>0; i--)
      {var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp};
  return array}


//==============================================================================

function ping() {
    return 'ready'
}

function start(r, rs, sc, pc) {
    role = r;
    library = definemorerules([], rs.slice(1));
    roles = findroles(library);
    state = findinits(library);
    startclock = numberize(sc);
    playclock = numberize(pc);
    return 'ready'
}

function play(move) {
  if (move !== nil) {
      var stateSignature = JSON.stringify(move);
      visitedStates[stateSignature] = role;
      compexecute(move, state, library)

  };

  if (findcontrol(state, library) !== role) {
      return false
  };

  return playIterativeDeepening(role)
}

function stop(move) {
    return false
}

function abort() {
    return false
}


//==============================================================================
// End of player code
//==============================================================================
  </script>
</head>

<!--=======================================================================-->

<body bgcolor='#aabbbb' onload='doinitialize()'>
  <center>
    <table width='720' cellspacing='0' cellpadding='40' bgcolor='#ffffff'>
      <tr>
        <td>

<!--=======================================================================-->

<center>
  <table width='640' cellpadding='0'>
    <tr>
      <td width='180' align='center' valign='center'>
        <img width='130' src='http://gamemaster.stanford.edu/images/ggp.jpg'/>
      </td>
      <td align='center'>
        <span style='font-size:18pt'>&nbsp;</span>
        <span style='font-size:32pt'>Gamemaster</span><br/>
      </td>
      <td width='180' align='center' style='color:#000066;font-size:18px'>
        <i>General<br/>Game<br/>Playing</i>
      </td>
    </tr>
  </table>
</center>

<!--=======================================================================-->

<br/>
<table width='640' cellpadding='8' cellspacing='0' bgcolor='#f4f8f8' border='1'>
  <tr height='40'>
     <td align='center'>
<table style='color:#000066;font-size:18px'>
  <tr>
    <td>
Protocol: localstorage<br/>
Metagamer: none<br/>
Strategy: custom<br/>
Identifier: <span id='player'>aero</span> <img src="http://gamemaster.stanford.edu/images/pencil.gif" onclick='doplayer()'/>
    </td>
  </tr>
</table>
    </td>
  </tr>
</table>
<br/>

<!--=======================================================================-->

<center>
  <br/>
  <textarea id='transcript' style='font-family:courier' rows='30' cols='80' readonly></textarea>
</center>

<!--=======================================================================-->

        </td>
      </tr>
    </table>
  </center>
</body>

<!--=======================================================================-->

</html>
